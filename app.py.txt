import streamlit as st
import pandas as pd
from geopy.distance import geodesic

# --- CONFIGURACI√ìN DE P√ÅGINA ---
st.set_page_config(page_title="Asesor Hub - La Carlota", layout="wide", page_icon="üìà")

# --- ESTILOS VISUALES ---
st.markdown("""
    <style>
    .stApp { background-color: #f4f7f9; }
    .main-card { background-color: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
    div[data-testid="stMetricValue"] { color: #1B263B; font-weight: bold; }
    </style>
    """, unsafe_allow_html=True)

# --- INICIALIZACI√ìN DE DATOS ---
if 'clientes' not in st.session_state:
    st.session_state.clientes = []
    
# Coordenadas de referencia: La Carlota, C√≥rdoba
UBICACION_BASE = (-33.419, -63.298)

# --- SEGURIDAD ---
st.sidebar.title("üîê Acceso Profesional")
password = st.sidebar.text_input("Contrase√±a del Asesor", type="password")

if password == "asesor2026":
    # --- MEN√ö DE NAVEGACI√ìN ---
    tab1, tab2, tab3, tab4 = st.tabs(["üìä Dashboard", "üë• Agenda Clientes", "üöú Ofertas", "üéØ Match 48hs"])

    # --- TAB 1: DASHBOARD ---
    with tab1:
        st.title("Indicadores Econ√≥micos Real-Time")
        c1, c2, c3, c4 = st.columns(4)
        c1.metric("D√≥lar MEP", "$1.185,00", "-0.2%")
        c2.metric("Soja Rosario", "USD 295,00", "+1.2%")
        c3.metric("√çndice ACARA", "+4.5%", "Mensual")
        c4.metric("UVA", "$945,20", "Hoy")
        
        st.divider()
        st.subheader("üì∞ Noticias de Relevancia")
        st.info("üìå **Mercado Inmobiliario:** Alta demanda de campos agr√≠colas en el sur de C√≥rdoba.")
        st.warning("‚ö†Ô∏è **BCRA:** Nuevas tasas de referencia para cr√©ditos productivos PyME.")

    # --- TAB 2: AGENDA (ARCA/ANSES) ---
    with tab2:
        st.header("Gesti√≥n de Clientes")
        with st.expander("‚ûï Cargar Nuevo Cliente (Validaci√≥n CUIT)"):
            with st.form("nuevo_cliente"):
                col_n, col_c = st.columns(2)
                nombre = col_n.text_input("Nombre o Raz√≥n Social")
                cuit = col_c.text_input("CUIT/CUIL (Sin guiones)")
                iva = st.selectbox("Condici√≥n IVA", ["Responsable Inscripto", "Monotributista", "Exento", "PyME"])
                actividad = st.text_input("Actividad (Seg√∫n Padr√≥n ARCA)")
                if st.form_submit_button("Agendar Cliente"):
                    st.session_state.clientes.append({"Nombre": nombre, "CUIT": cuit, "IVA": iva, "Actividad": actividad})
                    st.success(f"Cliente {nombre} guardado exitosamente.")

        if st.session_state.clientes:
            st.subheader("Contactos Agendados")
            st.dataframe(pd.DataFrame(st.session_state.clientes), use_container_width=True)

    # --- TAB 3: OFERTAS (FILTRO 400KM) ---
    with tab3:
        st.header("Buscador de Propuestas Comerciales")
        # Datos simulados de ofertas
        ofertas = [
            {"tipo": "Veh√≠culo", "item": "Hilux 2022", "loc": (-33.12, -64.34), "ciudad": "R√≠o Cuarto", "precio": "USD 35k"},
            {"tipo": "Campo", "item": "120 Ha Agr√≠colas", "loc": (-33.42, -63.15), "ciudad": "La Carlota", "precio": "Consultar"},
            {"tipo": "Maquinaria", "item": "Cosechadora JD", "loc": (-32.95, -60.64), "ciudad": "Rosario", "precio": "USD 120k"}
        ]
        
        for o in ofertas:
            dist = geodesic(UBICACION_BASE, o['loc']).km
            with st.container():
                st.write(f"### {o['item']} - {o['tipo']}")
                st.write(f"üìç {o['ciudad']} | üí∞ {o['precio']}")
                if dist <= 400:
                    st.success(f"‚úÖ Dentro del radio de 400km (Distancia: {dist:.1f} km)")
                else:
                    st.warning(f"üåê Oferta Nivel Pa√≠s (Distancia: {dist:.1f} km)")
                st.divider()

    # --- TAB 4: MATCHES (INTELIGENCIA) ---
    with tab4:
        st.header("Verificaci√≥n de Necesidades")
        if st.session_state.clientes:
            c_sel = st.selectbox("Seleccionar Cliente para verificar", [c['Nombre'] for c in st.session_state.clientes])
            tag = st.selectbox("¬øQu√© busca este cliente?", ["Camioneta", "Campo", "Cr√©dito Inversi√≥n"])
            
            if st.button("Ejecutar Match 48hs"):
                st.balloons()
                st.subheader(f"Resultados para {c_sel}:")
                if tag == "Camioneta":
                    st.write("üü¢ **Match:** Toyota Hilux 2022 en R√≠o Cuarto coincide con el perfil.")
                    st.button("Enviar Propuesta PDF por WhatsApp")
                else:
                    st.write("Buscando nuevas coincidencias en la base de datos...")
        else:
            st.write("Agende un cliente para activar el sistema de matching.")

else:
    st.image("https://img.icons8.com/clouds/200/lock-landscape.png")
    st.info("Por favor, ingrese la contrase√±a en la barra lateral para acceder.")